name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  CARGO_TERM_COLOR: always

jobs:
  rust-security:
    name: Rust Security Audit
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Install cargo-audit
      run: cargo install cargo-audit
    
    - name: Run cargo audit
      run: cargo audit
      working-directory: ./backend
    
    - name: Run cargo clippy
      run: cargo clippy --all-targets --all-features -- -D warnings
      working-directory: ./backend
    
    - name: Check for unsafe code
      run: |
        if grep -r "unsafe" backend/*/src --include="*.rs"; then
          echo "::warning::Unsafe code detected. Please review for security implications."
        fi

  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  smart-contract-security:
    name: Smart Contract Security
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Foundry
      uses: foundry-rs/foundry-toolchain@v1
    
    - name: Install dependencies
      run: forge install
      working-directory: ./backend/contracts
    
    - name: Run Slither static analysis
      uses: crytic/slither-action@v0.3.0
      with:
        target: './backend/contracts'
        slither-args: '--print human-summary'
        fail-on: medium
    
    - name: Run Mythril security analysis
      run: |
        pip install mythril
        myth analyze backend/contracts/src/ZkIPFSVerifier.sol --solv 0.8.19
      continue-on-error: true

  frontend-security:
    name: Frontend Security Scan
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/web/package-lock.json
    
    - name: Install dependencies
      run: npm ci
      working-directory: ./frontend/web
    
    - name: Run npm audit
      run: npm audit --audit-level moderate
      working-directory: ./frontend/web
    
    - name: Run ESLint security rules
      run: |
        npm install eslint-plugin-security --save-dev
        npx eslint . --ext .js,.jsx,.ts,.tsx --config .eslintrc-security.js
      working-directory: ./frontend/web
      continue-on-error: true

  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Run TruffleHog OSS
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

  license-compliance:
    name: License Compliance Check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install cargo-license
      run: cargo install cargo-license
    
    - name: Check Rust dependencies licenses
      run: |
        cd backend
        cargo license --json > licenses.json
        # Check for GPL or other copyleft licenses that might conflict with MIT
        if grep -q "GPL\|AGPL\|LGPL" licenses.json; then
          echo "::warning::Potential license conflict detected. Please review dependencies."
        fi
    
    - name: Check Node.js dependencies licenses
      run: |
        cd frontend/web
        npx license-checker --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD' --excludePrivatePackages
      continue-on-error: true

  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [rust-security, dependency-scan, smart-contract-security, frontend-security, secrets-scan, license-compliance]
    if: always()
    steps:
    - uses: actions/checkout@v4
    
    - name: Create security report
      run: |
        cat > security-report.md << 'EOF'
        # Security Scan Report
        
        **Date:** $(date)
        **Commit:** ${{ github.sha }}
        **Branch:** ${{ github.ref_name }}
        
        ## Scan Results
        
        - **Rust Security Audit:** ${{ needs.rust-security.result }}
        - **Dependency Scan:** ${{ needs.dependency-scan.result }}
        - **Smart Contract Security:** ${{ needs.smart-contract-security.result }}
        - **Frontend Security:** ${{ needs.frontend-security.result }}
        - **Secrets Detection:** ${{ needs.secrets-scan.result }}
        - **License Compliance:** ${{ needs.license-compliance.result }}
        
        ## Recommendations
        
        1. Review any warnings or failures above
        2. Update dependencies regularly
        3. Follow secure coding practices
        4. Conduct regular security reviews
        
        ## Next Steps
        
        - Address any high-severity vulnerabilities immediately
        - Schedule regular security audits
        - Keep dependencies up to date
        - Monitor security advisories
        EOF
    
    - name: Upload security report
      uses: actions/upload-artifact@v3
      with:
        name: security-report
        path: security-report.md
        retention-days: 30

  notify-security-issues:
    name: Notify Security Issues
    runs-on: ubuntu-latest
    needs: [rust-security, dependency-scan, smart-contract-security, frontend-security, secrets-scan]
    if: failure()
    steps:
    - name: Create security issue
      uses: actions/github-script@v6
      with:
        script: |
          const title = `Security Scan Failed - ${new Date().toISOString().split('T')[0]}`;
          const body = `
          ## Security Scan Failure
          
          One or more security scans have failed. Please review the workflow results and address any security issues.
          
          **Workflow:** ${{ github.workflow }}
          **Run ID:** ${{ github.run_id }}
          **Commit:** ${{ github.sha }}
          
          ### Failed Jobs
          - Rust Security: ${{ needs.rust-security.result }}
          - Dependency Scan: ${{ needs.dependency-scan.result }}
          - Smart Contract Security: ${{ needs.smart-contract-security.result }}
          - Frontend Security: ${{ needs.frontend-security.result }}
          - Secrets Detection: ${{ needs.secrets-scan.result }}
          
          Please investigate and resolve these security issues promptly.
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['security', 'bug', 'high-priority']
          });

